<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Журнал событий</title>
    <link rel="icon" type="image/png" href="./ico.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link id="manifest-link" rel="manifest">

    <style>
        /* Базовые стили */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Стили для кастомного скроллбара */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-700 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-600 */
        }
        #event-select-value {
            padding-right: 0.5rem; 
        }
        /* Стиль для анимации появления записей в логе */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-entry, .date-header {
            animation: fadeIn 0.3s ease-out;
        }
        /* Анимация для модального окна */
        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes zoomInModal {
            from { transform: scale(0.9); }
            to { transform: scale(1); }
        }
        .modal-fade-in {
            animation: fadeInModal 0.2s ease-out;
        }
        .modal-zoom-in {
            animation: zoomInModal 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-indigo-900/50 text-gray-200">

    <div class="min-h-screen flex items-center justify-center p-4">
        
        <div class="w-full max-w-2xl bg-gray-800/50 backdrop-blur-xl border border-gray-700/50 rounded-2xl shadow-2xl p-6 sm:p-8">
            <h1 class="text-3xl font-bold text-center mb-8 text-white">Журнал событий</h1>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="shift-input" class="block mb-2 text-sm font-medium text-gray-400 uppercase tracking-wider">Смена</label>
                    <input type="text" id="shift-input" class="bg-gray-700/50 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 placeholder-gray-500 transition" placeholder="Название смены">
                </div>

                <div>
                    <label for="position-input" class="block mb-2 text-sm font-medium text-gray-400 uppercase tracking-wider">Позиция</label>
                    <div class="relative flex items-center">
                        <input type="text" id="position-input" class="bg-gray-700/50 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 pr-10 placeholder-gray-500 transition" placeholder="Название позиции">
                        <div id="position-gps-status" class="absolute right-3 top-1/2 -translate-y-1/2" title="Статус GPS для позиции">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label for="event-select-button" class="block mb-2 text-sm font-medium text-gray-400 uppercase tracking-wider">Событие</label>
                <div id="custom-event-select-container" class="relative">
                    <button id="event-select-button" type="button" class="bg-gray-700/50 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-2 focus:ring-offset-0 focus:ring-indigo-500 focus:outline-none block w-full p-3 text-left flex justify-between items-center transition hover:border-gray-500">
                        <span id="event-select-value" class="truncate">-- Не выбрано --</span>
                        <svg class="w-4 h-4 ml-2 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="event-options-panel" class="hidden absolute z-10 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg">
                        <ul id="event-options-list" class="py-1 text-sm text-gray-200 max-h-60 overflow-y-auto custom-scrollbar"></ul>
                    </div>
                </div>
                 <div id="custom-event-container" class="mt-4 hidden">
                    <div class="flex space-x-2">
                        <input type="text" id="custom-event-input" class="flex-grow bg-gray-700/50 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 placeholder-gray-500 transition" placeholder="Название события">
                        <button id="add-event-button" class="bg-indigo-600 text-white font-semibold px-4 py-2.5 rounded-lg hover:bg-indigo-700 transition">ОК</button>
                    </div>
                </div>
            </div>
            
            <div id="distance-calculator-wrapper" class="mb-4"></div>

            <div class="mb-4">
                <div class="flex items-center mb-2">
                    <input id="azimuth-checkbox" type="checkbox" class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500 focus:ring-offset-gray-800">
                    <label for="azimuth-checkbox" class="ml-2 text-sm font-medium text-gray-300">Указать азимут</label>
                </div>
                <div id="azimuth-container" class="hidden">
                     <input type="text" id="azimuth-input" class="bg-gray-700/50 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 placeholder-gray-500 transition" placeholder="например, 270 или 100-130">
                </div>
            </div>
            
            <div class="flex items-center mb-4">
                <input id="comment-checkbox" type="checkbox" class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500 focus:ring-offset-gray-800">
                <label for="comment-checkbox" class="ml-2 text-sm font-medium text-gray-300">Добавить комментарий</label>
            </div>

            <div id="comment-container" class="mb-6 hidden">
                <label for="comment-input" class="block mb-2 text-sm font-medium text-gray-400 uppercase tracking-wider">Краткий комментарий</label>
                <textarea id="comment-input" rows="2" class="bg-gray-700/50 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 placeholder-gray-500 transition resize-none" placeholder="Введите ваш комментарий..."></textarea>
            </div>

            <div class="mt-6 mb-6">
                <button id="log-event-button" disabled class="w-full flex items-center justify-center bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-all duration-300 transform active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                    <span>Подтвердить</span>
                </button>
            </div>

            <hr class="border-gray-700">

            <div id="log-container" class="mt-6">
                <div class="flex justify-between items-center mb-4 gap-4">
                    <h2 class="text-lg font-semibold text-white flex-shrink-0">Последние события</h2>
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <button id="install-button" title="Установить приложение" class="text-sm text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-lg transition hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button id="json-button" title="Скачать JSON" class="text-sm text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-lg transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </button>
                        <button id="stats-button" title="Показать статистику" class="text-sm text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-lg transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                        </button>
                        <button id="clear-log-button" title="Очистить журнал" class="text-sm text-gray-400 hover:text-white hover:bg-gray-700 p-2 rounded-lg transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <ul id="log-list" class="max-h-[60vh] space-y-2 overflow-y-auto pr-2 custom-scrollbar"></ul>
            </div>
        </div>
    </div>
    
    <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-fade-in">
        <div id="stats-modal-content" class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700 modal-zoom-in">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-bold text-white">Статистика</h3>
                <button id="stats-modal-close" class="p-2 -mr-2 text-2xl leading-none text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="stats-body" class="p-6 max-h-[60vh] overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden modal-fade-in">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 modal-zoom-in p-6 text-center">
            <h3 class="text-lg font-bold text-white mb-4">Подтверждение</h3>
            <p id="confirm-modal-text" class="text-gray-400 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-clear-btn" class="bg-gray-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-gray-700 transition">Отмена</button>
                <button id="confirm-clear-btn" class="bg-red-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-red-700 transition">Удалить</button>
            </div>
        </div>
    </div>


    <script>
        // --- Глобальные переменные ---
        const shiftInput = document.getElementById('shift-input');
        const positionInput = document.getElementById('position-input');
        const positionGpsStatus = document.getElementById('position-gps-status');
        const eventSelectValue = document.getElementById('event-select-value');
        const azimuthCheckbox = document.getElementById('azimuth-checkbox');
        const azimuthContainer = document.getElementById('azimuth-container');
        const azimuthInput = document.getElementById('azimuth-input');
        const commentCheckbox = document.getElementById('comment-checkbox');
        const commentContainer = document.getElementById('comment-container');
        const commentInput = document.getElementById('comment-input');
        const logEventButton = document.getElementById('log-event-button');
        const logList = document.getElementById('log-list');
        const clearLogButton = document.getElementById('clear-log-button');
        const statsButton = document.getElementById('stats-button');
        const statsModal = document.getElementById('stats-modal');
        const statsModalClose = document.getElementById('stats-modal-close');
        const statsBody = document.getElementById('stats-body');
        const installButton = document.getElementById('install-button');
        const jsonButton = document.getElementById('json-button');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmClearBtn = document.getElementById('confirm-clear-btn');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');
        const distanceCalculatorWrapper = document.getElementById('distance-calculator-wrapper');

        // !!! ВАЖНО: Вставьте сюда URL вашего веб-приложения Apps Script !!!
        const googleScriptUrl = 'https://script.google.com/macros/s/AKfycbxDTD_Nfl6r0RuJR1OfxlHEQR5zDZA95v9oNzLWtb3ltzHn8Xnhu534iaQbEhtP7kI1/exec';

        // --- Структура данных ---
        let appData = { logs: {}, customEvents: [], positions: {} };
        let confirmCallback = null;
        let localDistanceLog = [];
        let deferredPrompt;
        
        // --- Конфигурация ---
        const MORTAR_TYPES = {
            'Минометный обстрел 82мм': { maxRange: 4000 },
            'Минометный обстрел 120мм': { maxRange: 7100 }
        };
        const SPEED_OF_SOUND = 343; // м/с
        
        // --- Управление данными ---
        function saveData() { localStorage.setItem('eventLogData', JSON.stringify(appData)); }
        function loadData() { 
            const data = localStorage.getItem('eventLogData'); 
            if (data) { 
                const parsedData = JSON.parse(data);
                appData = { ...{ logs: {}, customEvents: [], positions: {} }, ...parsedData };
            }
            // Загружаем последние использованные значения
            const lastShift = localStorage.getItem('lastShift');
            if (lastShift) shiftInput.value = lastShift;

            const lastPosition = localStorage.getItem('lastPosition');
            if (lastPosition) {
                positionInput.value = lastPosition;
                updatePositionGpsStatus();
                renderLog();
            }
        }

        // --- Утилиты ---
        function stringToColor(str) {
            if (!str || typeof str !== 'string') return 'hsl(0, 0%, 70%)';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 80%, 70%)`;
        }

        function escapeHTML(str) {
            if (!str) return '';
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }
        
        // --- Геолокация ---
        function setGpsStatus(status) {
            const svg = positionGpsStatus.querySelector('svg');
            svg.classList.remove('text-gray-500', 'text-yellow-400', 'text-green-400', 'text-red-400', 'animate-pulse');
            switch (status) {
                case 'loading':
                    svg.classList.add('text-yellow-400', 'animate-pulse');
                    break;
                case 'success':
                    svg.classList.add('text-green-400');
                    break;
                case 'error':
                    svg.classList.add('text-red-400');
                    break;
                default:
                    svg.classList.add('text-gray-500');
                    break;
            }
        }

        function updatePositionGpsStatus() {
            const positionName = positionInput.value.trim();
            if (positionName && appData.positions[positionName]) {
                setGpsStatus('success');
            } else {
                setGpsStatus('none');
            }
        }
        
        function getGPSForPosition() {
            const positionName = positionInput.value.trim();
            if (!positionName || appData.positions[positionName]) {
                updatePositionGpsStatus();
                return;
            }

            if ("geolocation" in navigator) {
                setGpsStatus('loading');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        appData.positions[positionName] = location;
                        saveData();
                        console.log(`GPS for "${positionName}" saved:`, location);
                        setGpsStatus('success');
                    },
                    (error) => {
                        console.error("Geolocation error:", error.message);
                        setGpsStatus('error');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                console.log("Geolocation not supported");
                setGpsStatus('error');
            }
        }
        
        // --- Синхронизация с Google Sheets ---
        function sendDataToGoogleSheet(eventData) {
            if (!googleScriptUrl) return;
            const formData = new FormData();
            formData.append('Timestamp', eventData.timestamp);
            formData.append('Shift', eventData.shift);
            formData.append('Position', eventData.position.name);
            formData.append('Event', eventData.name);
            formData.append('Azimuth', eventData.azimuth || '');
            formData.append('Distance', eventData.distance || '');
            formData.append('Comment', eventData.comment || '');
            formData.append('Latitude', eventData.position.location ? eventData.position.location.lat : '');
            formData.append('Longitude', eventData.position.location ? eventData.position.location.lon : '');
            formData.append('Accuracy', eventData.position.location ? eventData.position.location.accuracy : '');
            formData.append('DistanceLog', JSON.stringify(eventData.distanceLog));
            
            fetch(googleScriptUrl, { method: 'POST', body: formData})
                .then(res => res.json())
                .then(data => console.log('Google Sheet response:', data))
                .catch(err => console.error('Google Sheet send error:', err));
        }

        function deleteDataFromGoogleSheet(timestamp) {
             if (!googleScriptUrl) return;
             fetch(`${googleScriptUrl}?action=delete&timestamp=${encodeURIComponent(timestamp)}`)
                .then(res => res.json())
                .then(data => console.log('Google Sheet delete response:', data))
                .catch(err => console.error('Google Sheet delete error:', err));
        }

        function clearDataInGoogleSheet(shift, position) {
            if (!googleScriptUrl) return;
            fetch(`${googleScriptUrl}?action=clear&shift=${encodeURIComponent(shift)}&position=${encodeURIComponent(position)}`)
                .then(res => res.json())
                .then(data => console.log('Google Sheet clear response:', data))
                .catch(err => console.error('Google Sheet clear error:', err));
        }


        // --- Валидация ---
        function isValidAzimuth(value) {
            if (value.trim() === '') return true;
            const parts = value.split('-').map(p => p.trim());
            if (parts.length > 2) return false;
            for (const part of parts) {
                if (part === '') return false;
                const num = Number(part);
                if (isNaN(num) || num < 0 || num > 360) return false;
            }
            if (parts.length === 2 && Number(parts[0]) >= Number(parts[1])) return false;
            return true;
        }

        azimuthInput.addEventListener('input', () => {
            azimuthInput.classList.toggle('border-red-500', !isValidAzimuth(azimuthInput.value));
            azimuthInput.classList.toggle('border-gray-600', isValidAzimuth(azimuthInput.value));
            updateLogButtonState();
        });

        azimuthCheckbox.addEventListener('change', () => {
            azimuthContainer.classList.toggle('hidden', !azimuthCheckbox.checked);
            if (!azimuthCheckbox.checked) {
                azimuthInput.value = '';
                azimuthInput.dispatchEvent(new Event('input'));
            }
        });
        
        // --- Логика журнала ---
        function updateLogButtonState() {
            const shiftSet = shiftInput.value.trim() !== '';
            const positionSet = positionInput.value.trim() !== '';
            const eventSelected = eventSelectValue.dataset.value && eventSelectValue.dataset.value !== '-- Не выбрано --';
            const azimuthValid = isValidAzimuth(azimuthInput.value);
            logEventButton.disabled = !(shiftSet && positionSet && eventSelected && azimuthValid);
        }

        function deleteLogEntry(logKey, timestamp) {
            if (!appData.logs[logKey]) return;
            appData.logs[logKey] = appData.logs[logKey].filter(event => event.timestamp !== timestamp);
            if (appData.logs[logKey].length === 0) {
                delete appData.logs[logKey];
            }
            saveData();
            renderLog();
            deleteDataFromGoogleSheet(timestamp); // Синхронизация удаления
        }

        function logEvent() {
            const shiftName = shiftInput.value.trim();
            const positionName = positionInput.value.trim();
            const eventName = eventSelectValue.dataset.value;
            const azimuthValue = azimuthCheckbox.checked ? azimuthInput.value.trim() : null;
            const commentValue = commentCheckbox.checked ? commentInput.value.trim() : null;
            const distanceInput = document.getElementById('distance-input');
            const distanceValue = distanceInput ? distanceInput.value : null;
            
            if (!shiftName || !positionName || !eventName || eventName === '-- Не выбрано --' || !isValidAzimuth(azimuthInput.value)) return;

            const logKey = `${shiftName} | ${positionName}`;
            if (!appData.logs[logKey]) { appData.logs[logKey] = []; }
            
            const newEvent = { 
                name: eventName,
                shift: shiftName,
                timestamp: new Date().toISOString(), 
                azimuth: azimuthValue, 
                comment: commentValue, 
                distance: distanceValue || null, 
                distanceLog: localDistanceLog,
                position: {
                    name: positionName,
                    location: appData.positions[positionName] || null
                }
            };
            
            appData.logs[logKey].push(newEvent);
            saveData();
            renderLog();
            sendDataToGoogleSheet(newEvent); // Синхронизация добавления

            // Сброс полей
            azimuthInput.value = '';
            azimuthInput.classList.remove('border-red-500');
            azimuthInput.classList.add('border-gray-600');
            azimuthCheckbox.checked = false;
            azimuthContainer.classList.add('hidden');

            commentInput.value = '';
            commentCheckbox.checked = false;
            commentContainer.classList.add('hidden');
            commentInput.style.height = 'auto';

            if(distanceInput) {
                distanceInput.value = '';
                const clearBtn = document.getElementById('clear-distance-log-btn');
                if(clearBtn) clearBtn.click();
            }

            updateLogButtonState();
        }

        function clearLog() {
            const shiftName = shiftInput.value.trim();
            const positionName = positionInput.value.trim();
            const logKey = `${shiftName} | ${positionName}`;
            if (logKey && appData.logs[logKey]) {
                delete appData.logs[logKey];
                saveData();
                renderLog();
                clearDataInGoogleSheet(shiftName, positionName); // Синхронизация очистки
            }
        }
        
        function renderLog() {
            const shiftName = shiftInput.value.trim();
            const positionName = positionInput.value.trim();
            const logKey = `${shiftName} | ${positionName}`;
            logList.innerHTML = '';
            const originalEvents = appData.logs[logKey] || [];

            if (originalEvents.length === 0) {
                logList.innerHTML = `<li class="text-center text-gray-500 pt-16">Журнал пуст</li>`;
                return;
            }

            const reversedEvents = [...originalEvents].reverse();
            let lastDate = null;

            reversedEvents.forEach(event => {
                const eventDateObj = new Date(event.timestamp);
                const eventDate = eventDateObj.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });

                if (eventDate !== lastDate) {
                    const dateHeader = document.createElement('li');
                    dateHeader.className = 'date-header sticky top-0 bg-gray-900/80 backdrop-blur-sm z-10 py-1';
                    dateHeader.innerHTML = `<p class="text-center text-xs font-semibold text-indigo-400 uppercase tracking-widest">${eventDate}</p>`;
                    logList.appendChild(dateHeader);
                    lastDate = eventDate;
                }

                const timestamp = eventDateObj.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const eventColor = stringToColor(event.name);
                const safeComment = escapeHTML(event.comment);
                const azimuthHtml = event.azimuth ? `<span class="inline-flex items-center text-sm text-cyan-400"><svg class="w-4 h-4 mr-1 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>${event.azimuth}°</span>` : '';
                const distanceHtml = event.distance ? `<span class="inline-flex items-center text-sm text-green-400"><svg class="w-4 h-4 mr-1 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>~${event.distance} м</span>` : '';
                const infoHtml = [azimuthHtml, distanceHtml].filter(Boolean).join('<span class="text-gray-600 font-sans mx-2">/</span>');
                const commentHtml = event.comment ? `<div class="bg-black/20 px-4 py-2 border-t border-gray-700/50"><p class="text-sm text-gray-400 italic whitespace-pre-wrap break-words">${safeComment}</p></div>` : '';
                
                const li = document.createElement('li');
                li.className = 'log-entry bg-gray-900/50 rounded-lg overflow-hidden transition-all duration-300 hover:bg-gray-800/70 shadow-md group';
                li.innerHTML = `<div class="p-3"><div class="grid grid-cols-12 gap-x-2 gap-y-1 items-center"><div class="col-span-12 sm:col-span-5 flex items-center"><span class="w-2.5 h-2.5 rounded-full mr-3 flex-shrink-0" style="background-color: ${eventColor};"></span><span class="font-bold text-base" style="color: ${eventColor};">${event.name}</span></div><div class="col-span-12 sm:col-span-4 text-left">${infoHtml}</div><div class="col-span-12 sm:col-span-3 flex items-center justify-end gap-2"><span class="text-sm text-gray-400 font-mono">${timestamp}</span><button data-timestamp="${event.timestamp}" class="delete-entry-btn p-1 text-gray-500 hover:text-white hover:bg-red-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Удалить запись"><svg class="w-3.5 h-3.5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div></div></div>${commentHtml}`;
                logList.appendChild(li);
            });
            logList.scrollTop = 0;
        }

        shiftInput.addEventListener('input', () => {
            localStorage.setItem('lastShift', shiftInput.value.trim());
            renderLog();
            updateLogButtonState();
        });
        positionInput.addEventListener('input', () => {
            localStorage.setItem('lastPosition', positionInput.value.trim());
            renderLog();
            updateLogButtonState();
            updatePositionGpsStatus();
        });
        positionInput.addEventListener('blur', getGPSForPosition);

        logEventButton.addEventListener('click', () => logEvent());
        commentCheckbox.addEventListener('change', () => { commentContainer.classList.toggle('hidden', !commentCheckbox.checked); });
        commentInput.addEventListener('input', () => { commentInput.style.height = 'auto'; commentInput.style.height = `${commentInput.scrollHeight}px`; });

        // --- Логика подтверждения ---
        function showConfirm(message, callback) {
            confirmModalText.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        clearLogButton.addEventListener('click', () => {
            const shiftName = shiftInput.value.trim();
            const positionName = positionInput.value.trim();
            const logKey = `${shiftName} | ${positionName}`;
            if (logKey && (appData.logs[logKey] || []).length > 0) {
                showConfirm(`Вы уверены, что хотите очистить журнал для смены "${shiftName}" на позиции "${positionName}"? Это действие необратимо.`, clearLog);
            }
        });

        logList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-entry-btn');
            if (deleteBtn) {
                const timestamp = deleteBtn.dataset.timestamp;
                const shiftName = shiftInput.value.trim();
                const positionName = positionInput.value.trim();
                const logKey = `${shiftName} | ${positionName}`;
                if (timestamp && logKey) {
                    showConfirm('Вы уверены, что хотите удалить эту запись?', () => {
                        deleteLogEntry(logKey, timestamp);
                    });
                }
            }
        });
        
        cancelClearBtn.addEventListener('click', () => { 
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        confirmClearBtn.addEventListener('click', () => { 
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        });

        confirmModal.addEventListener('click', (e) => { 
            if(e.target === confirmModal) { 
                confirmModal.classList.add('hidden');
                confirmCallback = null;
            }
        });

        // --- Логика статистики ---
        function showStatistics() {
            statsModal.classList.remove('hidden');
            const shiftName = shiftInput.value.trim();
            const positionName = positionInput.value.trim();
            const logKey = `${shiftName} | ${positionName}`;

            if (!logKey) {
                statsBody.innerHTML = `<p class="text-gray-400 text-center">Сначала введите смену и позицию.</p>`;
                return;
            }
            const events = appData.logs[logKey] || [];
            if (events.length === 0) {
                statsBody.innerHTML = `<p class="text-gray-400 text-center">Нет данных для анализа.</p>`;
                return;
            }
            const totalEvents = events.length;
            const eventCounts = {};
            const uniqueDays = new Set();
            events.forEach(event => {
                eventCounts[event.name] = (eventCounts[event.name] || 0) + 1;
                uniqueDays.add(new Date(event.timestamp).toLocaleDateString());
            });
            let statsHtml = `<div class="grid grid-cols-2 gap-4 mb-6 text-center"><div><div class="text-3xl font-bold">${totalEvents}</div><div class="text-sm text-gray-400">Всего событий</div></div><div><div class="text-3xl font-bold">${uniqueDays.size}</div><div class="text-sm text-gray-400">Активных дней</div></div></div><hr class="border-gray-700 mb-6"><div class="space-y-4">`;
            const sortedEvents = Object.entries(eventCounts).sort(([,a],[,b]) => b-a);
            sortedEvents.forEach(([name, count]) => {
                const percentage = ((count / totalEvents) * 100).toFixed(1);
                const color = stringToColor(name);
                statsHtml += `<div><div class="flex justify-between items-center mb-1 text-sm"><span class="font-bold" style="color: ${color};">${name}</span><span class="text-gray-400">${count} (${percentage}%)</span></div><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%; background-color: ${color};"></div></div></div>`;
            });
            statsHtml += `</div>`;
            statsBody.innerHTML = statsHtml;
        }
        statsButton.addEventListener('click', showStatistics);
        statsModalClose.addEventListener('click', () => statsModal.classList.add('hidden'));
        statsModal.addEventListener('click', (e) => { if (e.target === statsModal) { statsModal.classList.add('hidden'); } });
        
        // --- Логика JSON ---
        function exportToJson() {
            const shiftName = shiftInput.value.trim();
            const positionName = positionInput.value.trim();
            const logKey = `${shiftName} | ${positionName}`;
            const events = appData.logs[logKey];

            if (!events || events.length === 0) {
                alert("Нет данных для экспорта для текущей смены и позиции.");
                return;
            }

            const exportData = {
                shift: shiftName,
                position: {
                    name: positionName,
                    location: appData.positions[positionName] || null
                },
                events: events
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const date = new Date().toISOString().slice(0, 10);
            const safeShiftName = shiftName.replace(/[^a-z0-9]/gi, '_');
            const safePositionName = positionName.replace(/[^a-z0-9]/gi, '_');
            link.download = `${safePositionName}_${safeShiftName}_${date}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        jsonButton.addEventListener('click', exportToJson);

        // --- Логика калькулятора дистанции ---
        let timerStartTime = null;
        let timerInterval = null;

        function renderDistanceCalculator(eventName) {
            distanceCalculatorWrapper.innerHTML = '';
            const mortarType = MORTAR_TYPES[eventName];
            if (!mortarType) return;
            localDistanceLog = []; // Reset log for new calculator
            const calculatorHtml = `<div class="p-4 bg-gray-900/50 rounded-lg"><label class="block mb-3 text-sm font-medium text-gray-400 uppercase tracking-wider">Калькулятор дистанции</label><div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start"><div><div class="flex items-center gap-2 mb-2"><button id="distance-timer-btn" class="flex-grow bg-teal-600 text-white font-medium text-sm py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-200">Выход</button><button id="clear-distance-log-btn" title="Очистить замеры" class="p-2 text-gray-500 hover:text-white transition"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><div id="distance-output" class="text-gray-400 text-xs h-4">Нажмите "Выход" при вспышке...</div></div><div id="distance-log-container" class="bg-black/20 rounded-md p-2 min-h-[60px] max-h-24 overflow-y-auto custom-scrollbar"><ul id="distance-mini-log" class="text-sm font-mono text-gray-400 space-y-1"><li class="p-2 text-center text-gray-500 text-xs">Нет замеров</li></ul></div></div><input type="hidden" id="distance-input"></div>`;
            distanceCalculatorWrapper.innerHTML = calculatorHtml;
            const timerBtn = document.getElementById('distance-timer-btn');
            const outputEl = document.getElementById('distance-output');
            const miniLogUl = document.getElementById('distance-mini-log');
            const clearBtn = document.getElementById('clear-distance-log-btn');
            const distanceInput = document.getElementById('distance-input');
            const renderMiniLog = () => {
                if(localDistanceLog.length === 0) {
                    miniLogUl.innerHTML = '<li class="p-2 text-center text-gray-500 text-xs">Нет замеров</li>'; return;
                }
                miniLogUl.innerHTML = '';
                localDistanceLog.forEach(log => {
                    const li = document.createElement('li');
                    li.className = "text-yellow-400 text-center";
                    li.textContent = `+${log.timeDiff.toFixed(2)}s → ~${log.distance} м`;
                    miniLogUl.prepend(li);
                });
            };
            clearBtn.addEventListener('click', () => { localDistanceLog = []; distanceInput.value = ''; renderMiniLog(); });
            timerBtn.addEventListener('click', () => {
                if (!timerStartTime) {
                    timerStartTime = new Date();
                    timerBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                    timerBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    timerBtn.textContent = 'Приход';
                    timerInterval = setInterval(() => {
                        const elapsed = ((new Date() - timerStartTime) / 1000).toFixed(1);
                        outputEl.innerHTML = `Идет замер: <span class="font-mono text-yellow-400">${elapsed}s</span>`;
                    }, 100);
                } else {
                    clearInterval(timerInterval);
                    const timeDiff = (new Date() - timerStartTime) / 1000;
                    const distance = Math.round(timeDiff * SPEED_OF_SOUND);
                    localDistanceLog.push({ timeDiff, distance });
                    renderMiniLog();
                    distanceInput.value = distance;
                    outputEl.innerHTML = 'Результат добавлен в список.';
                    setTimeout(() => { outputEl.innerHTML = 'Нажмите "Выход" при вспышке...'; }, 2000);
                    timerStartTime = null;
                    timerBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                    timerBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    timerBtn.textContent = 'Выход';
                }
            });
        }
        
        // --- Логика кастомного выбора события ---
        const eventSelectContainer = document.getElementById('custom-event-select-container');
        const eventOptionsPanel = document.getElementById('event-options-panel');
        const eventOptionsList = document.getElementById('event-options-list');
        const eventSelectButton = document.getElementById('event-select-button');
        const customEventContainer = document.getElementById('custom-event-container');
        const customEventInput = document.getElementById('custom-event-input');
        const addEventButton = document.getElementById('add-event-button');
        const initialEvents = [ { name: 'Скид', custom: false }, { name: 'FPV', custom: false }, { name: 'Минометный обстрел 82мм', custom: false }, { name: 'Минометный обстрел 120мм', custom: false }, ];
        
        function getEvents() { return [...initialEvents, ...appData.customEvents]; }

        function renderEventOptions() {
            eventOptionsList.innerHTML = '';
            getEvents().forEach(event => {
                const li = document.createElement('li');
                li.className = 'px-4 py-2 hover:bg-gray-700 cursor-pointer flex justify-between items-center group';
                li.dataset.value = event.name;
                li.innerHTML = `<span>${event.name}</span>` + (event.custom ? `<button class="p-1 text-gray-500 hover:text-white hover:bg-red-600 rounded-full delete-event-btn opacity-0 group-hover:opacity-100" title="Удалить '${event.name}'"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>` : '');
                eventOptionsList.appendChild(li);
            });
            eventOptionsList.insertAdjacentHTML('beforeend', `<li class="px-4 py-2 hover:bg-gray-700 cursor-pointer text-indigo-400" data-value="custom">Создать свое событие...</li>`);
        }
        
        function addNewEvent() {
            const newEventName = customEventInput.value.trim();
            if (newEventName && !getEvents().some(e => e.name === newEventName)) {
                appData.customEvents.push({ name: newEventName, custom: true });
                saveData();
                eventSelectValue.textContent = newEventName;
                eventSelectValue.dataset.value = newEventName;
                renderEventOptions();
                customEventInput.value = '';
                customEventContainer.classList.add('hidden');
                updateLogButtonState();
            }
        }
        
        eventSelectButton.addEventListener('click', () => { eventOptionsPanel.classList.toggle('hidden'); });
        window.addEventListener('click', (e) => { if (!eventSelectContainer.contains(e.target)) eventOptionsPanel.classList.add('hidden'); });

        eventOptionsList.addEventListener('click', (e) => {
            if (e.target.closest('.delete-event-btn')) {
                e.stopPropagation();
                const eventNameToDelete = e.target.closest('li').dataset.value;
                appData.customEvents = appData.customEvents.filter(event => event.name !== eventNameToDelete);
                saveData();
                if (eventSelectValue.dataset.value === eventNameToDelete) {
                    eventSelectValue.textContent = '-- Не выбрано --';
                    eventSelectValue.dataset.value = '-- Не выбрано --';
                }
                renderEventOptions();
                updateLogButtonState();
                return;
            }

            const selectedLi = e.target.closest('li');
            if (!selectedLi) return;
            const value = selectedLi.dataset.value;

            if (value === 'custom') {
                customEventContainer.classList.remove('hidden');
                customEventInput.focus();
            } else {
                eventSelectValue.textContent = value;
                eventSelectValue.dataset.value = value;
                customEventContainer.classList.add('hidden');
            }
            
            if (value.includes('Минометный обстрел')) {
                azimuthCheckbox.checked = true;
                azimuthContainer.classList.remove('hidden');
            } else {
                azimuthCheckbox.checked = false;
                azimuthContainer.classList.add('hidden');
                azimuthInput.value = '';
                azimuthInput.dispatchEvent(new Event('input'));
            }

            renderDistanceCalculator(value);
            eventOptionsPanel.classList.add('hidden');
            updateLogButtonState();
        });

        addEventButton.addEventListener('click', addNewEvent);
        customEventInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addNewEvent(); });

        // --- Инициализация и PWA ---
        function initialize() {
            const manifest = {
                "name": "Журнал Событий",
                "short_name": "Журнал",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#1f2937",
                "theme_color": "#4f46e5",
                "icons": [
                    { "src": "https://placehold.co/192x192/1f2937/ffffff?text=Log", "type": "image/png", "sizes": "192x192" },
                    { "src": "https://placehold.co/512x512/1f2937/ffffff?text=Log", "type": "image/png", "sizes": "512x512" }
                ]
            };
            const manifestString = JSON.stringify(manifest);
            const blob = new Blob([manifestString], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('#manifest-link').setAttribute('href', manifestURL);

            loadData();
            renderEventOptions();
            updateLogButtonState();
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                installButton.classList.add('hidden');
            }
        });

        window.addEventListener('appinstalled', () => {
            installButton.classList.add('hidden');
            deferredPrompt = null;
            console.log('PWA was installed');
        });
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
    
</body>
</html>



